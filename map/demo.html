<html>

<head>
  <meta charset='utf-8' />
  <title>Test Map</title>
  <meta name='robots' content='noindex, nofollow'>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.css' rel='stylesheet' />
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
  <!-- styling -->
  <style>
    body {
      color: #404040;
      font: 400 15px/22px 'Source Sans Pro', 'Helvetica Neue', Sans-serif;
      margin: 0;
      padding: 0;
      -webkit-font-smoothing: antialiased;
    }

    .map {
      position: absolute;
      left: 0%;
      width: 100%;
      top: 0;
      bottom: 0;
    }

  </style>
</head>

<body>
  <div id='map' class='map'></div>

  <script>

    // This will let you use the .remove() function later on
    if (!('remove' in Element.prototype)) {
      Element.prototype.remove = function () {
        if (this.parentNode) {
          this.parentNode.removeChild(this);
        }
      };
    }

    // mapbox public access token
    // next iteration: retrieve from .yaml file
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2hlbGJ5LWdyZWVuIiwiYSI6ImNrMHNobWdrNTAwZW8zYnA5czQ5cWh4ankifQ.TWYVyG-n0cmhTGvKg31eow';

    // initialize map
    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/shelby-green/ckpe45kll0we417n7cgs8cxne',
      zoom: 5.5,
      center: [11.43, -10.082],
      scrollZoom: true
    });

    // back-end data
    // join csv data to geojson data on "ccid"
    const csvUrl = 'https://raw.githubusercontent.com/climatecabinet/scorecard-map/main/data/cc_scorecard_06082021_yearstr.csv';

    // when the map loads
    map.on('load', function() {
        Papa.parse(csvUrl, {
            download: true,
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                map.once('idle', () => {
                    console.log(results.data[0].geoid);
                    results.data.forEach(row => {
                        map.setFeatureState({
                            source: 'ga-house',
                            id: String(row.geoid) // feature.id can be string, but only if string can be cast as int
                        },
                        {
                            candidate: row.name,
                            party: row.party,
                            score: row.cc_score,
                        });
                    });

                    // GA house fill
                    map.addLayer({
                        'id': 'ga-house-fill',
                        'source': 'ga-house',
                        'type': 'fill',
                        'layout': {},
                        'paint': {
                          'fill-color':
                          ['case',
                            ['<', ['feature-state', 'score'], 1],
                            'rgba(255,255,255,0.3)',
                            '#fff',
                          ]
                        }
                    });

                    // GA house lines
                    map.addLayer({
                        'id': 'ga-house-lines',
                        'source': 'ga-house',
                        'type': 'line',
                        'layout': {},
                        'paint': {
                            'line-color': 'white'
                        }
                    });
                        
                });
            }});

        
            map.addSource("ga-house", {
                type: "geojson",
                data: "https://raw.githubusercontent.com/climatecabinet/scorecard-map/main/data/geospatial/reprojected-state-leg/house/GA-House.geojson",
                promoteId: 'geoid'
            })

            map.on('click', 'ga-house-fill', function (e) {
                var district = map.queryRenderedFeatures(e.point, { layers: ['ga-house-fill'] });
                var props = district[0].properties;
                console.log(props);
                var content = '<b>Candidate:</b></b> ' + props.name + '<br>';
                content += '<b>Party:</b> ' + props.party + '<br>';

                new mapboxgl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(content)
                    .addTo(map);
                });

    });



    //     // add layer sources
    //     // FL house
    //     map.addSource("fl-house", {
    //         type: "geojson",
    //         data: "https://raw.githubusercontent.com/climatecabinet/scorecard-map/main/data/geospatial/reprojected-state-leg/house/FL-House.geojson"
    //     })

    //     // GA house
    //     map.addSource("ga-house", {
    //         type: "geojson",
    //         data: "https://raw.githubusercontent.com/climatecabinet/scorecard-map/main/data/geospatial/reprojected-state-leg/house/GA-House.geojson"
    //     })

    //     // AL house
    //     map.addSource("al-house", {
    //         type: "geojson",
    //         data: "https://raw.githubusercontent.com/climatecabinet/scorecard-map/main/data/geospatial/reprojected-state-leg/house/AL-House.geojson"
    //     })

    //     // MS house
    //     map.addSource("ms-house", {
    //         type: "geojson",
    //         data: "https://raw.githubusercontent.com/climatecabinet/scorecard-map/main/data/geospatial/reprojected-state-leg/house/MS-House.geojson"
    //     })

    //     // LA house
    //     map.addSource("la-house", {
    //         type: "geojson",
    //         data: "https://raw.githubusercontent.com/climatecabinet/scorecard-map/main/data/geospatial/reprojected-state-leg/house/LA-House.geojson"
    //     })

    //     // TX house
    //     map.addSource("tx-house", {
    //         type: "geojson",
    //         data: "https://raw.githubusercontent.com/climatecabinet/scorecard-map/main/data/geospatial/reprojected-state-leg/house/TX-House.geojson"
    //     })

    //     // NM house
    //     map.addSource("nm-house", {
    //         type: "geojson",
    //         data: "https://raw.githubusercontent.com/climatecabinet/scorecard-map/main/data/geospatial/reprojected-state-leg/house/NM-House.geojson"
    //     })

    //     // AZ -> THE REST
    //     map.addSource("az-house", {
    //         type: "geojson",
    //         data: "https://raw.githubusercontent.com/climatecabinet/scorecard-map/main/data/geospatial/reprojected-state-leg/house/AZ-House.geojson"
    //     })

    //     map.addSource("ca-house", {
    //         type: "geojson",
    //         data: "https://raw.githubusercontent.com/climatecabinet/scorecard-map/main/data/geospatial/reprojected-state-leg/house/CA-House.geojson"
    //     })

    //     map.addSource("or-house", {
    //         type: "geojson",
    //         data: "https://raw.githubusercontent.com/climatecabinet/scorecard-map/main/data/geospatial/reprojected-state-leg/house/OR-House.geojson"
    //     })

    //     map.addSource("wa-house", {
    //         type: "geojson",
    //         data: "https://raw.githubusercontent.com/climatecabinet/scorecard-map/main/data/geospatial/reprojected-state-leg/house/WA-House.geojson"
    //     })

    //     map.addSource("id-house", {
    //         type: "geojson",
    //         data: "https://raw.githubusercontent.com/climatecabinet/scorecard-map/main/data/geospatial/reprojected-state-leg/house/ID-House.geojson"
    //     })

    //     map.addSource("mt-house", {
    //         type: "geojson",
    //         data: "https://raw.githubusercontent.com/climatecabinet/scorecard-map/main/data/geospatial/reprojected-state-leg/house/MT-House.geojson"
    //     })

    //     map.addSource("nd-house", {
    //         type: "geojson",
    //         data: "https://raw.githubusercontent.com/climatecabinet/scorecard-map/main/data/geospatial/reprojected-state-leg/house/ND-House.geojson"
    //     })

    //     map.addSource("mn-house", {
    //         type: "geojson",
    //         data: "https://raw.githubusercontent.com/climatecabinet/scorecard-map/main/data/geospatial/reprojected-state-leg/house/MN-House.geojson"
    //     })

    //     map.addSource("wi-house", {
    //         type: "geojson",
    //         data: "https://raw.githubusercontent.com/climatecabinet/scorecard-map/main/data/geospatial/reprojected-state-leg/house/WI-House.geojson"
    //     })

    //     map.addSource("mi-house", {
    //         type: "geojson",
    //         data: "https://raw.githubusercontent.com/climatecabinet/scorecard-map/main/data/geospatial/reprojected-state-leg/house/MI-House.geojson"
    //     })

    //     map.addSource("me-house", {
    //         type: "geojson",
    //         data: "https://raw.githubusercontent.com/climatecabinet/scorecard-map/main/data/geospatial/reprojected-state-leg/house/ME-House.geojson"
    //     })


    //     // show layers
    //     // FL house fill
    //     map.addLayer({
    //         'id': 'fl-house-fill',
    //         'source': 'fl-house',
    //         'type': 'fill',
    //         'layout': {},
    //         'paint': {
    //             'fill-color': '#d99f20'
    //         }
    //     });
    //     // FL house lines
    //     map.addLayer({
    //         'id': 'fl-house-lines',
    //         'source': 'fl-house',
    //         'type': 'line',
    //         'layout': {},
    //         'paint': {
    //             'line-color': 'white'
    //         }
    //     });
    //     // FL house district numbers
    // //     map.addLayer({
    // //         'id': 'fl-house-labels',
    // //         'source': 'fl-house',
    // //         'type': 'symbol',
    // //         'layout': {
    // //             'text-field': ['format', ['get', 'district'], {'font-scale': 0.8}],
    // //             'text-font': ['literal', ['Open Sans SemiBold', 'Arial Unicode MS Regular']],
    // //             'text-variable-anchor': ['top', 'bottom', 'left', 'right'],
    // //             'text-radial-offset': 0.4,
    // //             'text-justify': 'auto'
    // //         },
    // //         'paint': {
    // //             'text-color': '#000'
    // //         }
    // //   });

    //     // GA house fill
    //     map.addLayer({
    //         'id': 'ga-house-fill',
    //         'source': 'ga-house',
    //         'type': 'fill',
    //         'layout': {},
    //         'paint': {
    //             'fill-color': '#d99f20'
    //         }
    //     });
    //     // GA house lines
    //     map.addLayer({
    //         'id': 'ga-house-lines',
    //         'source': 'ga-house',
    //         'type': 'line',
    //         'layout': {},
    //         'paint': {
    //             'line-color': 'white'
    //         }
    //     });

    //     // AL house fill
    //     map.addLayer({
    //         'id': 'al-house-fill',
    //         'source': 'al-house',
    //         'type': 'fill',
    //         'layout': {},
    //         'paint': {
    //             'fill-color': '#d99f20'
    //         }
    //     });
    //     // AL house lines
    //     map.addLayer({
    //         'id': 'al-house-lines',
    //         'source': 'al-house',
    //         'type': 'line',
    //         'layout': {},
    //         'paint': {
    //             'line-color': 'white'
    //         }
    //     });

    //     // MS -> WA fill and lines
    //     map.addLayer({
    //         'id': 'ms-house-fill',
    //         'source': 'ms-house',
    //         'type': 'fill',
    //         'layout': {},
    //         'paint': {
    //             'fill-color': '#d99f20'
    //         }
    //     });
    //     map.addLayer({
    //         'id': 'ms-house-lines',
    //         'source': 'ms-house',
    //         'type': 'line',
    //         'layout': {},
    //         'paint': {
    //             'line-color': 'white'
    //         }
    //     });
    //     map.addLayer({
    //         'id': 'la-house-fill',
    //         'source': 'la-house',
    //         'type': 'fill',
    //         'layout': {},
    //         'paint': {
    //             'fill-color': '#d99f20'
    //         }
    //     });
    //     map.addLayer({
    //         'id': 'la-house-lines',
    //         'source': 'la-house',
    //         'type': 'line',
    //         'layout': {},
    //         'paint': {
    //             'line-color': 'white'
    //         }
    //     });
    //     map.addLayer({
    //         'id': 'tx-house-fill',
    //         'source': 'tx-house',
    //         'type': 'fill',
    //         'layout': {},
    //         'paint': {
    //             'fill-color': '#d99f20'
    //         }
    //     });
    //     map.addLayer({
    //         'id': 'tx-house-lines',
    //         'source': 'tx-house',
    //         'type': 'line',
    //         'layout': {},
    //         'paint': {
    //             'line-color': 'white'
    //         }
    //     });
    //     map.addLayer({
    //         'id': 'nm-house-fill',
    //         'source': 'nm-house',
    //         'type': 'fill',
    //         'layout': {},
    //         'paint': {
    //             'fill-color': '#d99f20'
    //         }
    //     });
    //     map.addLayer({
    //         'id': 'nm-house-lines',
    //         'source': 'nm-house',
    //         'type': 'line',
    //         'layout': {},
    //         'paint': {
    //             'line-color': 'white'
    //         }
    //     });

    //     map.addLayer({
    //         'id': 'az-house-fill',
    //         'source': 'az-house',
    //         'type': 'fill',
    //         'layout': {},
    //         'paint': {
    //             'fill-color': '#d99f20'
    //         }
    //     });
    //     map.addLayer({
    //         'id': 'az-house-lines',
    //         'source': 'az-house',
    //         'type': 'line',
    //         'layout': {},
    //         'paint': {
    //             'line-color': 'white'
    //         }
    //     });

    //     map.addLayer({
    //         'id': 'ca-house-fill',
    //         'source': 'ca-house',
    //         'type': 'fill',
    //         'layout': {},
    //         'paint': {
    //             'fill-color': '#d99f20'
    //         }
    //     });
    //     map.addLayer({
    //         'id': 'ca-house-lines',
    //         'source': 'ca-house',
    //         'type': 'line',
    //         'layout': {},
    //         'paint': {
    //             'line-color': 'white'
    //         }
    //     });

    //     map.addLayer({
    //         'id': 'or-house-fill',
    //         'source': 'or-house',
    //         'type': 'fill',
    //         'layout': {},
    //         'paint': {
    //             'fill-color': '#d99f20'
    //         }
    //     });
    //     map.addLayer({
    //         'id': 'or-house-lines',
    //         'source': 'or-house',
    //         'type': 'line',
    //         'layout': {},
    //         'paint': {
    //             'line-color': 'white'
    //         }
    //     });

    //     map.addLayer({
    //         'id': 'wa-house-fill',
    //         'source': 'wa-house',
    //         'type': 'fill',
    //         'layout': {},
    //         'paint': {
    //             'fill-color': '#d99f20'
    //         }
    //     });
    //     map.addLayer({
    //         'id': 'wa-house-lines',
    //         'source': 'wa-house',
    //         'type': 'line',
    //         'layout': {},
    //         'paint': {
    //             'line-color': 'white'
    //         }
    //     });

    //     map.addLayer({
    //         'id': 'id-house-fill',
    //         'source': 'id-house',
    //         'type': 'fill',
    //         'layout': {},
    //         'paint': {
    //             'fill-color': '#d99f20'
    //         }
    //     });
    //     map.addLayer({
    //         'id': 'id-house-lines',
    //         'source': 'id-house',
    //         'type': 'line',
    //         'layout': {},
    //         'paint': {
    //             'line-color': 'white'
    //         }
    //     });

    //     map.addLayer({
    //         'id': 'nd-house-fill',
    //         'source': 'nd-house',
    //         'type': 'fill',
    //         'layout': {},
    //         'paint': {
    //             'fill-color': '#d99f20'
    //         }
    //     });
    //     map.addLayer({
    //         'id': 'nd-house-lines',
    //         'source': 'nd-house',
    //         'type': 'line',
    //         'layout': {},
    //         'paint': {
    //             'line-color': 'white'
    //         }
    //     });

    //     map.addLayer({
    //         'id': 'mn-house-fill',
    //         'source': 'mn-house',
    //         'type': 'fill',
    //         'layout': {},
    //         'paint': {
    //             'fill-color': '#d99f20'
    //         }
    //     });
    //     map.addLayer({
    //         'id': 'mn-house-lines',
    //         'source': 'mn-house',
    //         'type': 'line',
    //         'layout': {},
    //         'paint': {
    //             'line-color': 'white'
    //         }
    //     });

    //     map.addLayer({
    //         'id': 'wi-house-fill',
    //         'source': 'wi-house',
    //         'type': 'fill',
    //         'layout': {},
    //         'paint': {
    //             'fill-color': '#d99f20'
    //         }
    //     });
    //     map.addLayer({
    //         'id': 'wi-house-lines',
    //         'source': 'wi-house',
    //         'type': 'line',
    //         'layout': {},
    //         'paint': {
    //             'line-color': 'white'
    //         }
    //     });

    //     map.addLayer({
    //         'id': 'mi-house-fill',
    //         'source': 'mi-house',
    //         'type': 'fill',
    //         'layout': {},
    //         'paint': {
    //             'fill-color': '#d99f20'
    //         }
    //     });
    //     map.addLayer({
    //         'id': 'mi-house-lines',
    //         'source': 'mi-house',
    //         'type': 'line',
    //         'layout': {},
    //         'paint': {
    //             'line-color': 'white'
    //         }
    //     });

    //     map.addLayer({
    //         'id': 'mt-house-fill',
    //         'source': 'mt-house',
    //         'type': 'fill',
    //         'layout': {},
    //         'paint': {
    //             'fill-color': '#d99f20'
    //         }
    //     });
    //     map.addLayer({
    //         'id': 'mt-house-lines',
    //         'source': 'mt-house',
    //         'type': 'line',
    //         'layout': {},
    //         'paint': {
    //             'line-color': 'white'
    //         }
    //     });

    //     map.addLayer({
    //         'id': 'me-house-fill',
    //         'source': 'me-house',
    //         'type': 'fill',
    //         'layout': {},
    //         'paint': {
    //             'fill-color': '#d99f20'
    //         }
    //     });
    //     map.addLayer({
    //         'id': 'me-house-lines',
    //         'source': 'me-house',
    //         'type': 'line',
    //         'layout': {},
    //         'paint': {
    //             'line-color': 'white'
    //         }
    //     });

    // })

  </script>
</body>

</html>